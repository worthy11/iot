# SSD1306 OLED Display Driver API Documentation

## Data Types

### `oled_scroll_dir_t`

Enumeration defining scroll directions:

- `SCROLL_NONE` - No scrolling
- `SCROLL_HORIZONTAL_LEFT` - Scroll horizontally to the left
- `SCROLL_HORIZONTAL_RIGHT` - Scroll horizontally to the right
- `SCROLL_VERTICAL_UP` - Scroll vertically upward
- `SCROLL_VERTICAL_DOWN` - Scroll vertically downward

## API Functions

### Initialization

#### `oled_init`

Initialize the OLED display and set up the driver.

**Signature:**

```c
void oled_init(i2c_master_dev_handle_t dev);
```

**Parameters:**

- `dev` - I2C master device handle for communication with the display

**Description:**
Initializes the SSD1306 display with default settings, creates mutexes for thread-safe operation, clears the framebuffer, and performs an initial display update. Must be called before using any other display functions.

**Example:**

```c
i2c_master_dev_handle_t i2c_dev;
// ... initialize i2c_dev ...
oled_init(i2c_dev);
```

---

### Display Control

#### `oled_display_on`

Turn on the OLED display.

**Signature:**

```c
void oled_display_on(void);
```

**Parameters:**
None

**Description:**
Activates the display, making it visible. The display must be initialized before calling this function.

---

#### `oled_display_off`

Turn off the OLED display.

**Signature:**

```c
void oled_display_off(void);
```

**Parameters:**
None

**Description:**
Deactivates the display to save power. The display content is preserved but not visible.

---

#### `oled_clear_display`

Clear the framebuffer (set all pixels to off).

**Signature:**

```c
void oled_clear_display(void);
```

**Parameters:**
None

**Description:**
Clears the internal framebuffer by setting all bytes to 0x00. This does not update the display automatically - call `oled_update_display()` to see the changes.

---

#### `oled_normal_display`

Set display to normal mode (non-inverted).

**Signature:**

```c
void oled_normal_display(void);
```

**Parameters:**
None

**Description:**
Sets the display to normal mode where pixels are displayed as drawn (on pixels appear bright, off pixels appear dark).

---

#### `oled_invert_display`

Invert the display colors.

**Signature:**

```c
void oled_invert_display(void);
```

**Parameters:**
None

**Description:**
Inverts the display so that on pixels appear dark and off pixels appear bright. Call `oled_normal_display()` to return to normal mode.

---

#### `oled_set_contrast`

Set the display contrast level.

**Signature:**

```c
void oled_set_contrast(uint8_t contrast);
```

**Parameters:**

- `contrast` - Contrast value (0-255). Higher values result in brighter display.

**Description:**
Adjusts the display contrast/brightness. The value ranges from 0 (lowest contrast) to 255 (highest contrast).

---

### Display Update

#### `oled_update_display`

Update the entire display with the current framebuffer contents.

**Signature:**

```c
void oled_update_display(void);
```

**Parameters:**
None

**Description:**
Transfers the entire framebuffer to the display hardware, updating all pixels.

---

#### `oled_update_display_partial`

Update a partial region of the display.

**Signature:**

```c
void oled_update_display_partial(uint8_t start_col, uint8_t end_col, uint8_t start_page, uint8_t end_page);
```

**Parameters:**

- `start_col` - Starting column (0-127)
- `end_col` - Ending column (0-127, must be >= start_col)
- `start_page` - Starting page (0-7, each page is 8 pixels tall)
- `end_page` - Ending page (0-7, must be >= start_page)

**Description:**
Updates only a specified rectangular region of the display, which is more efficient than updating the entire display when only a portion has changed.

**Example:**

```c
// Update only the first 64 columns of the first 2 pages (rows 0-15)
oled_update_display_partial(0, 63, 0, 1);
```

---

### Display Orientation

#### `oled_flip_horizontal`

Flip the display horizontally.

**Signature:**

```c
void oled_flip_horizontal(bool flip);
```

**Parameters:**

- `flip` - `true` to flip horizontally, `false` to restore normal orientation

**Description:**
Mirrors the display horizontally. When `flip` is `true`, the display is flipped along the vertical axis.

---

#### `oled_flip_vertical`

Flip the display vertically.

**Signature:**

```c
void oled_flip_vertical(bool flip);
```

**Parameters:**

- `flip` - `true` to flip vertically, `false` to restore normal orientation

**Description:**
Mirrors the display vertically. When `flip` is `true`, the display is flipped along the horizontal axis.

---

#### `oled_set_vertical_offset`

Set the vertical offset (start line) of the display.

**Signature:**

```c
void oled_set_vertical_offset(uint8_t offset);
```

**Parameters:**

- `offset` - Vertical offset value (0-63). The value is clamped to valid range.

**Description:**
Sets which row becomes the first visible row on the display. This effectively shifts the display content vertically. The offset is achieved by scrolling line by line until the desired offset is reached.

---

### Cursor Position

#### `oled_set_position`

Set the cursor position for drawing operations.

**Signature:**

```c
void oled_set_position(uint8_t x, uint8_t y);
```

**Parameters:**

- `x` - Row position (0-63). Values are clamped to 0x3F.
- `y` - Column position (0-127). Values are clamped to 0x7F.

**Description:**
Sets the cursor position where subsequent drawing operations (text, bitmaps) will start. The cursor position is used by `oled_draw_text()`, `oled_draw_text_inverse()`, and `oled_draw_bitmap()`.

**Example:**

```c
oled_set_position(10, 20);  // Set cursor to row 10, column 20
```

---

### Drawing Functions

#### `oled_draw_text`

Draw text on the display.

**Signature:**

```c
void oled_draw_text(const char *str, uint8_t font_size, uint16_t rotation);
```

**Parameters:**

- `str` - Null-terminated string to display
- `font_size` - Font size multiplier (1 or 2). Values outside this range are clamped.
- `rotation` - Text rotation in degrees (0, 90, 180, or 270). Other values default to 0.

**Description:**
Draws a text string at the current cursor position using an 8x8 pixel font. The font can be scaled (1x or 2x) and rotated. After drawing, the cursor position is restored to its original value. The function uses the standard ASCII character set.

**Example:**

```c
oled_set_position(0, 0);
oled_draw_text("Hello", 1, 0);  // Draw "Hello" at normal size, no rotation
```

---

#### `oled_draw_text_inverse`

Draw inverted text on the display.

**Signature:**

```c
void oled_draw_text_inverse(const char *str, uint8_t font_size, uint16_t rotation);
```

**Parameters:**

- `str` - Null-terminated string to display
- `font_size` - Font size multiplier (1 or 2). Values outside this range are clamped.
- `rotation` - Text rotation in degrees (0, 90, 180, or 270). Other values default to 0.

**Description:**
Similar to `oled_draw_text()`, but draws text with inverted colors (background becomes foreground and vice versa). Useful for highlighting text or creating contrast.

**Example:**

```c
oled_set_position(0, 0);
oled_draw_text_inverse("ALERT", 2, 0);  // Draw inverted text at 2x size
```

---

#### `oled_draw_bitmap`

Draw a bitmap image on the display.

**Signature:**

```c
void oled_draw_bitmap(const uint8_t *data, uint8_t image_width, uint8_t image_height);
```

**Parameters:**

- `data` - Pointer to bitmap data array. Data format: each row is represented by bytes where MSB is the leftmost pixel. Each byte represents 8 horizontal pixels.
- `image_width` - Width of the image in pixels
- `image_height` - Height of the image in pixels

**Description:**
Draws a monochrome bitmap image starting at the current cursor position. The bitmap data should be organized row by row, with each byte representing 8 horizontal pixels (MSB = leftmost pixel). If the image extends beyond the display boundaries, it will be clipped. The cursor position is not automatically advanced after drawing.

**Example:**

```c
// Example: 16x16 bitmap (2 bytes per row, 16 rows)
uint8_t bitmap_data[32] = { /* ... bitmap data ... */ };
oled_set_position(10, 20);
oled_draw_bitmap(bitmap_data, 16, 16);
```

---

### Scrolling Functions

#### `oled_scroll_horizontal`

Enable horizontal scrolling on the display.

**Signature:**

```c
void oled_scroll_horizontal(oled_scroll_dir_t direction, uint32_t speed_ms, uint8_t start_page, uint8_t end_page);
```

**Parameters:**

- `direction` - Scroll direction (`SCROLL_HORIZONTAL_LEFT` or `SCROLL_HORIZONTAL_RIGHT`)
- `speed_ms` - Scroll speed in milliseconds (1-1000). Values outside this range are clamped.
- `start_page` - Starting page for scroll area (0-7). Values are masked to 0x07.
- `end_page` - Ending page for scroll area (0-7). Values are masked to 0x07. Must be >= start_page.

**Description:**
Enables hardware-accelerated horizontal scrolling for a specified page range. The scrolling is continuous and uses the display's built-in scrolling feature. Call `oled_scroll_off()` to stop scrolling.

**Example:**

```c
// Scroll entire display horizontally to the right at 100ms intervals
oled_scroll_horizontal(SCROLL_HORIZONTAL_RIGHT, 100, 0, 7);
```

---

#### `oled_scroll_vertical`

Enable vertical scrolling on the display.

**Signature:**

```c
void oled_scroll_vertical(oled_scroll_dir_t direction, uint32_t speed_ms);
```

**Parameters:**

- `direction` - Scroll direction (`SCROLL_VERTICAL_UP` or `SCROLL_VERTICAL_DOWN`)
- `speed_ms` - Scroll speed in milliseconds (1-1000). Values outside this range are clamped.

**Description:**
Enables software-based vertical scrolling. This creates a FreeRTOS task that continuously scrolls the display vertically at the specified speed. The scrolling affects the entire display. Call `oled_scroll_off()` to stop scrolling.

**Example:**

```c
// Scroll display vertically downward at 50ms intervals
oled_scroll_vertical(SCROLL_VERTICAL_DOWN, 50);
```

---

#### `oled_scroll_diagonal`

Enable diagonal scrolling on the display.

**Signature:**

```c
void oled_scroll_diagonal(oled_scroll_dir_t v_direction, oled_scroll_dir_t h_direction, uint32_t speed_ms, uint8_t vertical_offset);
```

**Parameters:**

- `v_direction` - Vertical scroll direction (`SCROLL_VERTICAL_UP` or `SCROLL_VERTICAL_DOWN`)
- `h_direction` - Horizontal scroll direction (`SCROLL_HORIZONTAL_LEFT` or `SCROLL_HORIZONTAL_RIGHT`)
- `speed_ms` - Scroll speed in milliseconds
- `vertical_offset` - Vertical offset (currently unused in implementation)

**Description:**
Enables simultaneous horizontal and vertical scrolling, creating a diagonal scrolling effect. This combines hardware horizontal scrolling with software vertical scrolling. Call `oled_scroll_off()` to stop scrolling.

**Example:**

```c
// Scroll diagonally (down and right) at 75ms intervals
oled_scroll_diagonal(SCROLL_VERTICAL_DOWN, SCROLL_HORIZONTAL_RIGHT, 75, 0);
```

---

#### `oled_scroll_line`

Scroll the display by one line.

**Signature:**

```c
void oled_scroll_line(oled_scroll_dir_t direction);
```

**Parameters:**

- `direction` - Scroll direction (`SCROLL_VERTICAL_UP` or `SCROLL_VERTICAL_DOWN`)

**Description:**
Scrolls the display by exactly one pixel line in the specified direction. This is a single-step operation, not continuous scrolling. Useful for manual scrolling control or for implementing the vertical offset feature.

**Example:**

```c
// Scroll down by one line
oled_scroll_line(SCROLL_VERTICAL_DOWN);
```

---

#### `oled_scroll_off`

Disable all scrolling.

**Signature:**

```c
void oled_scroll_off(void);
```

**Parameters:**
None

**Description:**
Stops all active scrolling (both hardware and software-based). This deactivates hardware scrolling and terminates any running scroll tasks. Should be called before changing scroll modes or when scrolling is no longer needed.

**Example:**

```c
oled_scroll_off();  // Stop all scrolling
```

---

## Thread Safety

The driver uses FreeRTOS mutexes to ensure thread-safe operation. Multiple tasks can safely call display functions concurrently. The following mutexes are used:

- **Framebuffer mutex**: Protects framebuffer access during drawing operations
- **Display mutex**: Protects hardware communication during display updates and control commands

## Notes

- All drawing operations modify the internal framebuffer. Call `oled_update_display()` or `oled_update_display_partial()` to transfer changes to the display hardware.
- The display uses a page-based memory organization where each page is 8 pixels tall.
- Text drawing functions restore the cursor position after completion, so multiple text calls at the same position will overwrite each other.
- Scrolling functions may conflict with each other. Always call `oled_scroll_off()` before changing scroll modes.
- The driver requires FreeRTOS for mutex and task management.

## Dependencies

- `driver/i2c_master.h` - I2C communication
- `stdint.h` - Standard integer types
- `stdbool.h` - Boolean type
- `stddef.h` - Standard definitions
- FreeRTOS (for mutexes and tasks)
